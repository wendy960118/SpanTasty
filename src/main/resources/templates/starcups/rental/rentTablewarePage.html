<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/" class="wide wow-animation" lang="en">
<head>
<title>Order Online</title>
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<!-- Stylesheets-->
<!-- 更改樣式 -->
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Poppins:400,500%7CTeko:300,400,500%7CMaven+Pro:500">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="/SpanTasty/starcups/css/bootstrap.css">
<link rel="stylesheet" href="/SpanTasty/starcups/css/fonts.css">
<link rel="stylesheet" href="/SpanTasty/starcups/css/style.css">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.5/dist/sweetalert2.all.min.js"></script>
<style>
.ie-panel {
  display: none;
  background: #212121;
  padding: 10px 0;
  box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, .3);
  clear: both;
  text-align: center;
  position: relative;
  z-index: 1;
}

html.ie-10 .ie-panel,
html.lt-ie-10 .ie-panel {
  display: block;
}

#cartContainer {
  display: none;
}

#cartContainer.active {
  display: block;
}
   
#cartIcon, .disable-link {
  pointer-events: none;
  opacity: 0.3;
}

.rd-navbar-basket {
    padding-right: 14px !important;
}

.product-top-panel {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start !important; 
    justify-content: center;
}


</style>
</head>

<body>
  <!-- navbar  th:replace=-->
  <div th:replace="~{starcups/display/navbar}"></div>
  <div class="ie-panel"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img
        src="images/ie8-panel/warning_bar_0000_us.jpg" height="42" width="820"
        alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."></a>
  </div>
  <div class="preloader">
    <div class="preloader-body">
      <div class="cssload-container"><span></span><span></span><span></span><span></span>
      </div>
    </div>
  </div>
  <div class="page">
    <!-- Page Header-->
    <header class="section page-header">
      <!-- RD Navbar-->
      <!-- delete 55-433 -->
    </header>
    <!-- Breadcrumbs -->
    <section class="section breadcrumbs-custom-inset">
      <div class="breadcrumbs-custom context-dark">
        <div class="container">
          <h2 class="breadcrumbs-custom-title">開始租借</h2>
          <ul class="breadcrumbs-custom-path">
            <li><a href="/SpanTasty/StarCups">Home</a></li>
            <!-- <li><a href="grid-gallery.html">Menu</a></li> -->
            <li><a href="/SpanTasty/StarCups/rental/home">租借</a></li>
            <li class="active">開始租借</li>
          </ul>
        </div>
        <div class="box-position novi-bg novi-bg-img" style="background-image: url('/SpanTasty/StarCups/images/bg-breadcrumbs.jpg');"></div>
      </div>
    </section>
    <!-- Shop-->
    <section class="section novi-bg novi-bg-img section-xl bg-default pb-1">
      <div class="container">
        <div class="row row-90 row-fix justify-content-center">
          <div class="col-lg-8 col-xl-9 pe-4" style="width: 1170px;">
            <div class="product-top-panel group-lg">
            <div class="content m-0" id="container">
              <table class="table mb-0 table-secondary" style="width: 600px; border:1px solid lightgrey;">
		        <caption>請先選擇租借餐廳 再選擇租借品項</caption>
                <tr>
                  <td>租借餐廳:
                    <select name="restaurantId" id="restaurantId" style="width: 500px;" required onchange="changeRestaurant()">
                      <option value="" selected disabled>請選擇租借餐廳</option>
                      <option th:each="restaurant : ${restaurants}" th:value="${restaurant.restaurantId}" th:text="${restaurant.restaurantName}"></option>
                    </select>
                  </td>
                </tr>
              </table>
            </div>
                  <!-- 購物車 -->
              <div class="rd-navbar-basket-wrap mt-4">
                <div>
                  <button id="cartIcon" class="rd-navbar-basket rd-navbar-basket-mobile" data-rd-navbar-toggle=".cart-inline">
                    <i class="fa-solid fa-cart-arrow-down"></i>
                    <!-- 動態更新數量 -->
                    <span id="showCartAmount"></span></button>
                </div>
                <div class="cart-inline toggle-original-elements" id="cartContainer">
                  <!-- 動態插入資訊 -->
                  <div class="cart-inline-header" id="cartHeaderContainer">
                    <h5 class="cart-inline-title">購物車: <span id="showAmount">0</span> Products</h5>
                  </div>
                  <div class="cart-inline-body pe-0 pb-0">
                    <!-- 動態插入購物車內容 -->
                    <div class="cart-inline-item" id="cartItemsContainer">
                      <div class="unit align-items-center">
                        <div class="unit-left">
                          <div>
                            <a href="single-product.html">
                              <img src="/SpanTasty/upload/order/americano.jpeg" alt="" width="100" height="100" /></a>
                          </div>
                        </div>
                        <div class="unit-body">
                          <h6 class="cart-inline-name"><a href="single-product.html">Burdur Pearl</a></h6>
                          <div>
                            <div class="group-xs group-middle-2">
                              <h6 class="cart-inline-title" id="itemPrice">$289</h6>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
	                  <div class="cart-inline-footer pb-3 pt-3">
	                    <div class="group-sm ">
	                      <a class="button button-md button-primary button-pipaluk" onclick="submitCart()">結帳</a>
	                      <h6 class="ms-5 ps-5 pt-2 cart-inline-title position-absolute top-15 end-10">總金額: <span id="showTotalPrice">$524</span></h6>
	                    </div>
	                  </div>
                </div>
               </div>
              </div>
             </div>
            </div>
           </div>
          </section>
	
	
	<!-- Section Pricing-->
	<section class="section novi-bg novi-bg-img section-xl bg-default pt-4">
     <div class="container">
      <div class="row row-40">
       <div class="col-sm-6 col-lg-4 p-0" th:each="tableware : ${tablewares}">
       <a class="disable-link" th:id="'single' + ${tableware.tablewareId}">
          <div class="box-pricing pt-1 me-0 ms-0 ps-0 pe-0">
            <div class="box-pricing-body">
              <div class="box-pricing-caption">
              <img th:src="${tableware.tablewareImage != null ? tableware.tablewareImage : 'https://via.placeholder.com/450x400'}" alt="" width="180" height="180" style="height:180px;" />
                <h6 class="box-pricing-title" th:text="${tableware.tablewareName}"></h6>
                <h4 class="box-pricing-price"><span>NT$</span><span class="box-icon-classic-title" th:text="${tableware.tablewareDeposit}"></span></h4>
                <div class="quantity-selector">
                  <div class="table-cart-stepper">
                    <input class="form-input" th:id="'rentItemQuantity'+${tableware.tablewareId}" type="number" data-zeros="true" value="0" min="0" max="1000">
                  </div>
                </div>
            	<span style="position: absolute; bottom: 50px; right: 10px; color:red;" th:id="'stock' + ${tableware.tablewareId}"></span>
              </div>
            </div>
            <div class="box-pricing-button mt-1"><button class="button button-lg button-block button-gray-4 pt-0 pb-0" th:data-tablewareId="${tableware.tablewareId}" onclick="addToCart(this)"><i class="fa-solid fa-cart-arrow-down" style="font-size:23px;"></i></button></div>
          </div>
        </a>
       </div>
      </div>
     </div>
   	</section>


    
    
<!-- Global Mailform Output-->
 <div class="snackbars" id="form-output-global"></div>
 <!-- footer  th:replace=-->
 <div th:replace="~{starcups/display/footer}" ></div>

<!-- Javascript-->
<script src="/SpanTasty/starcups/js/core.min.js"></script>
<script src="/SpanTasty/starcups/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
// 顯示購物車內容
document.addEventListener("DOMContentLoaded", function () {
  // 顯示購物車內容
  document.getElementById("cartIcon").addEventListener("click", function () {
    document.getElementById("cartContainer").classList.toggle("active");
  });

  reloadCartItems(); // 頁面加載時載入購物車
})

function updateCartCount(count) {
  document.getElementById('showCartAmount').textContent = count; // 更新購物車數量顯示
}

// 頁面加載時從 localStorage 讀取購物車資料
window.onload = function () {
  let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
  updateCartCount(cartItems.length); // 初始化購物車數量
}

function addToCart(button) {
    const tablewareId = button.getAttribute('data-tablewareid'); // 正確獲取 tablewareId
    const rentItemQuantity = parseInt(document.getElementById(`rentItemQuantity${tablewareId}`).value, 10);
    // 檢查數量是否為 0，如果為 0 則不允許加入購物車
    if (rentItemQuantity === 0) {
        Swal.fire('錯誤', '請至少選擇庫存1', 'error');
        return;
    }
    const restaurantId = document.getElementById("restaurantId").value;
	const url = 'http://localhost:8080/SpanTasty/StarCups/rental/tableware';
    let dtoObject = {
      tablewareId: tablewareId
    };
    // 透過 axios 從後端抓取商品資料
    axios.post(url, dtoObject) // 使用正確的 tablewareId 發送請求
        .then(function (response) {
            const itemData = response.data; // 從後端獲取的商品資料，假設包含名稱、圖片、價格、庫存
			const quantityInput = document.getElementById(`rentItemQuantity${tablewareId}`);
            // 從 localStorage 中獲取當前的購物車資料
            let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];

            // 檢查購物車是否已有此商品
            let existingItem = cartItems.find(item => item.tablewareId === tablewareId);
            if (existingItem) {
                existingItem.rentItemQuantity = parseInt(existingItem.rentItemQuantity) + rentItemQuantity;
            } else {
                // 如果是新的商品，則新增到購物車
                cartItems.push({
                    tablewareId: tablewareId,
                    rentItemQuantity: rentItemQuantity,
                    restaurantId: restaurantId,
                    itemName: itemData.tablewareName, // 從後端獲取的名稱
                    itemImage: itemData.tablewareImage, // 從後端獲取的圖片
                    itemPrice: itemData.tablewareDeposit // 從後端獲取的價格
                });
            }
            // 更新 localStorage
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
	
            // 更新購物車顯示
            updateCartUI(cartItems);

            // 更新顯示的庫存（庫存邏輯已由 updateStock 處理）
            
            const stockElement = document.getElementById(`stock${tablewareId}`);
            let stock = parseInt(stockElement.innerHTML.replace('剩', '').replace('件', ''), 10);
            //stock -= rentItemQuantity;
            //stockElement.innerHTML = `剩${stock}件`;
            
            quantityInput.value = 0; 
            Swal.fire('成功', '加入購物車', 'success');
            updateStock([{ tablewareId: tablewareId, stock: stock }]);
        })
        .catch(function (error) {
            console.error(error);
        });
}

// 更新購物車 UI
function updateCartUI(cartItems) {
    const cartContainer = document.getElementById('cartItemsContainer');
    const showCartAmount = document.getElementById('showCartAmount');
    const showAmount = document.getElementById('showAmount');
    const showTotalPrice = document.getElementById('showTotalPrice');
    let totalPrice = 0;

    // 清空購物車內容
    cartContainer.innerHTML = '';

    // 更新購物車顯示
    cartItems.forEach((item, index) => {
        const itemTotalPrice = parseInt(item.itemPrice) * parseInt(item.rentItemQuantity);
        totalPrice += itemTotalPrice;

        const cartItemHtml = `
        <div class="cart-inline-item">
          <div class="unit align-items-center border-bottom mb-0" style="height:85px">
            <div class="unit-left">
              <img src="${item.itemImage}" alt="" width="70" height="70" style="height:70px"/>
            </div>
            <div class="unit-body ms-2 mb-0 pb-3" style="width:170px">
              <span class="fs-7 ">${item.itemName}</span>
              <br/>
              <br/>
              <span> X </span> <span class="fs-7">${item.rentItemQuantity}</span><span> </span><span> NT$${itemTotalPrice}</span>
            </div>
              <div class="unit-right ms-1 mb-0 mt-4 pt-3" style="width:130px; text-align:right;">
                  <button onclick="removeFromCart(${index})" style="font-size:18px;border:none; background-color:white;" class="pe-3"><i class="fa-solid fa-trash-can-arrow-up"></i></button>
              </div>
          </div>
        </div>`;
        
        cartContainer.insertAdjacentHTML("beforeend", cartItemHtml);
    });

    // 更新總數和總價
    showAmount.textContent = cartItems.length;
    showCartAmount.textContent = cartItems.length;
    showTotalPrice.textContent = `NT$${totalPrice}`;
}

function submitCart() {
    const token = localStorage.getItem('token');
    const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];

    if (cartItems.length === 0) {
        Swal.fire('錯誤', '購物車是空的', 'error');
        return;
    }

    axios.post(`/SpanTasty/StarCups/rental/addCart`, cartItems, {
        headers: {
            'Authorization': `${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(function (response) {
        if (response.status === 200) {
        	Swal.fire({
			    icon: 'question',
			    title: '提交購物車',
			    text: '確定提交購物車後 無法再更動租借用品',
			    showCancelButton: true,
			    confirmButtonColor: "#3085d6",
        		cancelButtonColor: "#d33",
			    confirmButtonText: "確定",
        		cancelButtonText: "取消"
			}).then((result) => {
			    console.log(result)
			    if(result.isConfirmed){
		            localStorage.removeItem('cartItems'); // 清空購物車
		            updateCartCount(0); // 重置購物車顯示
		            updateCartUI([]);
		            window.location.href = "/SpanTasty/StarCups/rental/cart"; 
			    }
			})
        } else {
            Swal.fire('錯誤', '提交失敗', 'error');
        }
    })
    .catch(function (error) {
        console.log(error);
    });
}
      
function reloadCartItems() {
    let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
    updateCartUI(cartItems); // 初始化顯示
    updateCartCount(cartItems.length); // 更新購物車數量
}
      
function removeFromCart(index) {
    // 從 localStorage 中讀取購物車資料
    let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
    
    const removedItem = cartItems[index];
    
    // 刪除指定索引的商品
    cartItems.splice(index, 1);
    
    // 更新 localStorage 中的購物車資料
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
    
    // 更新購物車顯示
    updateCartUI(cartItems);
    updateCartCount(cartItems.length);
    
    if (removedItem) {
        const stockElement = document.getElementById(`stock${removedItem.tablewareId}`);
        const linkElement = document.getElementById(`single${removedItem.tablewareId}`);
        const quantityInput = document.getElementById(`rentItemQuantity${removedItem.tablewareId}`);
        if (stockElement && linkElement && quantityInput) {
            // 獲取當前庫存
            let currentStock = parseInt(stockElement.innerHTML.replace('剩', '').replace('件', ''), 10);
            
            // 增加庫存數量
            currentStock += removedItem.rentItemQuantity;
            
            // 更新庫存顯示
            stockElement.innerHTML = `剩${currentStock}件`;
            
            // 更新輸入框最大值
            quantityInput.max = currentStock;
            
            // 如果庫存大於 0，則恢復啟用選項
            if (currentStock > 0) {
                linkElement.classList.remove('disabled');
                linkElement.style.pointerEvents = 'auto'; // 恢復點擊事件
                linkElement.style.opacity = '1'; // 改回正常不透明度
                quantityInput.disabled = false; // 啟用數量輸入框
            }
        }
    }
}
      
      
      

  function changeRestaurant() {
    localStorage.removeItem('cartItems'); // 清空購物車
    updateCartCount(0); // 更新購物車顯示為 0
    document.getElementById('cartIcon').style.pointerEvents = 'auto'; // 恢復購物車點擊功能
    document.getElementById('cartIcon').style.opacity = '1';
	document.querySelectorAll('.disable-link').forEach(function(link) {
	    link.style.pointerEvents = 'auto';
	    link.style.opacity = '1'; // 恢復商品點擊功能
	});
    const restaurantId = document.getElementById("restaurantId").value;
    const url = 'http://localhost:8080/SpanTasty/StarCups/rental/showRestaurantStock';
    let dtoObject = {
      restaurantId: restaurantId
    };
    axios.post(url, dtoObject)
      .then(function (response) {
        //htmlMaker(response.data);
        console.log(response.data.stocks);
        updateStock(response.data.stocks);
      })
      .catch(function (error) {
        console.log(error);
      });
  }

  function updateStock(stocks) {
	stocks.forEach(stock => {
	// 根據 tablewareId 查找對應的 span 標籤
	const stockElement = document.getElementById(`stock${stock.tablewareId}`);
	const linkElement = document.getElementById(`single${stock.tablewareId}`);
	const quantityInput = document.getElementById(`rentItemQuantity${stock.tablewareId}`);
	const stepUpArrow = document.querySelector(`#rentItemQuantity${stock.tablewareId} ~ .up`);
    const stepDownArrow = document.querySelector(`#rentItemQuantity${stock.tablewareId} ~ .down`);

      if (stockElement && quantityInput) {
        // 插入剩餘庫存資料
        stockElement.innerHTML = `剩${stock.stock}件`;
        if (Number(stock.stock) === 0) {
          linkElement.classList.add('disabled');
          linkElement.style.pointerEvents = 'none'; // 禁用點擊事件
          linkElement.style.opacity = '0.2'; // 改變樣式表示禁用狀態
          quantityInput.value = 0;
        } else {
	       	quantityInput.value = 0;
	        quantityInput.max = stock.stock; 
	        // 手動輸入監聽，防止超過庫存
	        quantityInput.addEventListener('input', function () {
	          const max = parseInt(quantityInput.max, 10);
	          const min = parseInt(quantityInput.min, 10);
	          const value = parseInt(quantityInput.value, 10);
	          
	          if (value > max) {
	            Swal.fire('錯誤', '已達最大庫存', 'warning');
	            quantityInput.value = max; // 限制數值為最大值
	          } else if (value < min) {
	            Swal.fire('錯誤', '庫存已為0', 'warning');
	            quantityInput.value = min; // 限制數值為最小值
	          }
	          
	          // 動態更新剩餘庫存
	          stockElement.innerHTML = `剩 ${max - value} 件`;
	        });
	        
	        // 監聽步進器上箭頭點擊事件
	        stepUpArrow.addEventListener('click', function () {
	          const currentValue = parseInt(quantityInput.value, 10);
	          const max = parseInt(quantityInput.max, 10);
	          if (currentValue > max) {
	            Swal.fire('注意', '已達最大庫存', 'warning');
	            quantityInput.value = max;
	          }
	          // 更新剩餘庫存
	          stockElement.innerHTML = `剩 ${max - quantityInput.value} 件`;
	        });
	
	        // 監聽步進器下箭頭點擊事件
	        stepDownArrow.addEventListener('click', function () {
	          const currentValue = parseInt(quantityInput.value, 10);
	          const min = parseInt(quantityInput.min, 10);
	          if (currentValue < min) {
	            Swal.fire('錯誤', '庫存已為0', 'warning');
	            quantityInput.value = min;
	          } 
	          // 更新剩餘庫存
	          stockElement.innerHTML = `剩 ${parseInt(quantityInput.max, 10) - quantityInput.value} 件`;
	        });
        }
      } else {
        console.log(`Element with id stock${stock.tablewareId} not found`);
      }
    });
  }

</script>
</body>
</html>