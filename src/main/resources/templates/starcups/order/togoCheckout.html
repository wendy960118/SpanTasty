<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/" class="wide wow-animation" lang="en">

<head>
  <title>Checkout</title>
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <!-- Stylesheets-->
  <!-- 更改樣式 -->
  <link rel="stylesheet" type="text/css"
    href="https://fonts.googleapis.com/css?family=Poppins:400,500%7CTeko:300,400,500%7CMaven+Pro:500">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/bootstrap.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/fonts.css">
  <link rel="stylesheet" href="/SpanTasty/starcups/css/style.css">
  <style>
    .ie-panel {
      display: none;
      background: #212121;
      padding: 10px 0;
      box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, .3);
      clear: both;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    html.ie-10 .ie-panel,
    html.lt-ie-10 .ie-panel {
      display: block;
    }

    .point {
      letter-spacing: .1em;
      color: #9b9b9b;
    }

    .pointText {
      font-size: 20px;
    }

    .box-sportlight-badge {
      top: 0 !important;
      font-size: 15px !important;
    }

    .addBtn {
      width: 60px;
      height: 36px;
      border: 0;
      background-color: #efc4a3;
      border-radius: 3px;
    }

    .cantUse {
      filter: opacity(50%) grayscale(100%);
    }
    
    .dropdown-time {
  	  max-height: 50px; 
  	  overflow-y: auto;  
	}

  </style>
</head>

<body>
  <!-- navbar  th:replace=-->
  <div th:replace="~{starcups/display/navbar}"></div>
  <div class="ie-panel"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img
        src="images/ie8-panel/warning_bar_0000_us.jpg" height="42" width="820"
        alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."></a>
  </div>
  <div class="preloader">
    <div class="preloader-body">
      <div class="cssload-container"><span></span><span></span><span></span><span></span>
      </div>
    </div>
  </div>
  <div class="page">
    <!-- Page Header-->
    <header class="section page-header">
      <!-- RD Navbar-->

    </header>
    <!-- Breadcrumbs -->
    <section class="section breadcrumbs-custom-inset">
      <div class="breadcrumbs-custom context-dark">
        <div class="container">
          <h2 class="breadcrumbs-custom-title">Checkout</h2>
          <ul class="breadcrumbs-custom-path">
            <li><a href="/SpanTasty/StarCups">Home</a></li>
            <li><a href="/SpanTasty/StarCups/order">Order Online</a></li>
            <li class="active">Checkout</li>
          </ul>
        </div>
        <div class="box-position novi-bg novi-bg-img" style="background-image: url('/SpanTasty/starcups/images/bg-breadcrumbs.jpg');"></div>
      </div>
    </section>
    <!-- Section checkout form-->
    <!-- <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start"> -->
    <section>
      <div class="container">
        <!-- 刪除帳單地址填寫框 -->
        <div class="row row-50 justify-content-center">
        </div>
      </div>
    </section>
    <!-- Shopping Cart-->
    <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start">
      <div class="container">
        <div class="group-xmd group-middle">
          <h4 class="text-spacing-50">購物車資訊</h4>
          <div style="display: flex; align-items: center; margin-left: auto; margin-bottom: 10px;">
            <h6 class="text-gray-500" style="margin-right: 10px;">Total</h6>
            <h3 class="cart-product-price"><sup>$</sup>524</h3>
          </div>
        </div>
        <!-- shopping-cart-->
        <div class="table-custom-responsive">
          <table class="table-custom table-cart">
            <thead>
              <tr>
                <th>品項</th>
                <th>單價</th>
                <th>數量</th>
                <th>小計</th>
              </tr>
            </thead>
            <!-- 購物車資訊 -->
            <tbody>
              <tr>
                <td>
                  <!-- 圖片 -->
                  <div class="table-cart-figure" style="margin-right: 30px;">
                    <img src="images/product-mini-7-146x132.png" alt="" width="146" height="132" />
                  </div>
                  <!-- 名稱 -->
                  <div class="table-cart-link">Burdur Pearl</div>
                </td>
                <!-- 價格 -->
                <td>$289</td>
                <!-- 數量 -->
                <td>1</td>
                <!-- 單項總價 -->
                <td>$235</td>
              </tr>
            </tbody>
          </table>
          <!-- discount -->
          <div class="table-custom-responsive border p-3">
            <!-- coupon -->
            <div class="row p-3">
              <span class="point" style="font-size: 16px;">優惠券</span>
              <div class="col-7">
                <div class="form-wrap">
                  <input class="form-input form-input-inverse" id="coupon-code" type="text" name="email" disabled>
                  <label class="form-label" for="coupon-code" id="coupon-code-label">Coupon code</label>
                </div>
              </div>
              <div class="col-3">
                <div class="form-button">
                  <button class="button button-secondary button-pipaluk" type="submit" id="selectCoupon">新增優惠券</button>
                </div>
              </div>
              <div class="col"></div>
            </div>
            <!-- point -->
            <div class="row mt-3 p-3">
              <div class="col-7">
                <span class="point" style="font-size: 16px;" id="pointItem">點數折抵</span>
                <div class="form-wrap text-align-center" id="pointItem">
                  <input class="form-input form-input-inverse pointText" id="pointInput" type="text" name="email"
                    style="font-size: 20px;">
                  <label class="form-label" for="pointInput">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Point</label>
                </div>
              </div>
              <div class="col-4 d-flex align-items-end">
                <ul class="point" id="pointInfo">
                  <li class="active" style="font-size: 16px;">可用點數 : 910點(1點折抵1元)</li>
                  <li class="active" style="font-size: 16px;">您有 45點將於 2024/13/31到期</li>
                </ul>
              </div>
              <div class="col"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Modal click select coupon jump out by hao-->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">選擇優惠券</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row ms-1 me-1 " style="background-color: #F7F7F7;height: 70px;">
              <div class="col-3 d-flex justify-content-end align-items-center">新增優惠券</div>
              <div class="col-6 d-flex align-items-center"><input type="text" class="form-control" id="modelCouponCode">
              </div>
              <div class="col-3 d-flex align-items-center"><button class="addBtn" id="add">新增</button></div>
            </div>
            <!--  -->
            <div id="couponDiv" class="mt-2">
              <!-- <div class="row">
                  <div class="col d-flex mb-3">
                    <div class="d-flex" style="background-color: rgb(232, 208, 192);"><img src="/SpanTasty/starcups/images/coupon/couponhead.png" width="87" height="87" alt=""></div>
                    <div class="border w-100 d-flex justify-content-between">
                      <div class="ms-1 mt-1">                                                        
                        <ul class="">
                          <li><span>歡慶三周年</span><span></span></li>
                          <li><span>低消 </span><span>$100</span></li>
                          <li><span>最多折抵 </span><span>$10</span></li>
                          <li><span>有效日期: </span><span>2024/12/31</span><a href="#" class="ms-2 rule" data-couponid=${coupon.coupon.couponId}>使用規則</a></li>
                        </ul>
                      </div>
                      <div class="d-flex align-items-center me-3">
                        <input type="radio"  name="selectCoupon">  
                      </div>                                                       
                      <div class="box-sportlight-badge box-sportlight-sale mb-3">x 3</div>      
                    </div>
                  </div> -->
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="useCoupon" data-bs-dismiss="modal">使用</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Section payment-->
    <section class="section novi-bg novi-bg-img section-xl bg-default text-md-start" style="padding-top: 0px;">
      <div class="container">
        <div class="row row-50 justify-content-center">
          <!-- 取餐資訊 -->
          <div class="col-md-10 col-lg-6">
            <h4 class="text-spacing-50">取餐資訊</h4>
            <div class="row row-14 row-fix gutters-14" style="margin-top: 25px;">
              <!--Select 2-->

              <div class="col-sm-6">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="citySelect" onchange="fetchTowns()">
                  <option value="">選擇縣市</option>
                </select>
              </div>
              <div class="col-sm-6">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="townSelect" disabled onchange="fetchRestaurants()">
                  <option value="">選擇鄉鎮</option>
                </select>
              </div>
              <div class="col-sm-6">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="restaurantSelect" disabled onchange="createPickupTime()">
                  <option value="">選擇餐廳</option>
                </select>
              </div>
              <div class="col-sm-6">
                <select class="form-input select-filter" data-minimum-results-for-search="Infinity"
                  data-constraints="@Required" id="timeSelect" disabled>
                  <option value="">選擇時間</option>
                  <!-- style="overflow: auto; height: 50px" -->
                </select>
              </div>
            </div>
            <h4 class="text-spacing-50" style="margin-top: 30px;">顧客資料</h4>
            <form class="rd-form rd-mailform">
              <div class="row row-14 row-fix gutters-14">
                <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="tgName" type="text" name="tgName" data-constraints="@Required"
                      placeholder="姓名" />
                    <label class="form-label" for="tgName"></label>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-wrap">
                    <input class="form-input" id="tgPhone" type="text" name="tgPhone" data-constraints="@Required"
                      placeholder="電話" />
                    <label class="form-label" for="tgPhone"></label>
                  </div>
                </div>
                <div class="col-sm-12">
                  <div class="form-wrap">
                    <label class="form-label" for="togoMemo"></label>
                    <textarea class="form-input" name="togoMemo" id="togoMemo" placeholder="餐點備註"></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="col-md-10 col-lg-6">
            <h4 class="text-spacing-50">付款方式</h4>
            <div class="box-radio">
              <div class="radio-panel">
                <label class="radio-inline active">
                  <input name="input-group-radio" value="checkbox-1" type="radio" checked readonly>現金支付
                </label>
                <div class="radio-panel-content">
                  <p>僅供門市現金支付</p>
                </div>
              </div>
            </div>
            <h4 class="text-spacing-50" style="margin-top: 30px;">購物車金額</h4>
            <div class="table-custom-responsive">
              <table class="table-custom table-custom-primary table-checkout">
                <tbody>
                  <tr>
                    <td>Cart Subtotal</td>
                    <td id="subtotal">$524</td>
                  </tr>
                  <tr>
                    <td>Coupon Discount</td>
                    <td id="couponDiscountTd" data-discount="">-</td>
                  </tr>
                  <tr>
                    <td>Point Discount</td>
                    <td id="pointDiscountTd" data-discount="">-</td>
                  </tr>
                  <tr>
                    <td>Total</td>
                    <td id="total">$524</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- 訂單送出 -->
        <div class="button-wrap text-center">
          <button class="button button-secondary button-pipaluk" id="submitTogoBtn" type="submit">送出訂單</button>
        </div>
      </div>
    </section>

    <!-- Page Footer-->
    <footer class="section footer-variant-2 footer-modern context-dark novi-bg novi-bg-img">
    </footer>
  </div>
  <!-- Global Mailform Output-->
  <div class="snackbars" id="form-output-global"></div>
  <!-- footer th:replace -->
  <div th:replace="~{starcups/display/footer}"></div>
  <script>
    function countSubtotal() {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      let subtotal = 0;
      cart.forEach(item => {
        const itemTotalPrice = item.foodPrice * item.quantity;
        subtotal += itemTotalPrice
      })
      return subtotal;
    }
    let memberId;
    let conponCode;
    let couponId;
    let discountAmount;
    let finalAmount = countSubtotal();


    document.addEventListener("DOMContentLoaded", function () {
      loadCartIntoTable(); // 頁面加載時調用
      getProfile();



      //訂單提交
      document.getElementById("submitTogoBtn").addEventListener("click", function () {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        // 如果購物車是空的，則提醒用戶
        if (cart.length === 0) {
          alert("您的購物車是空的，無法進行結帳！");
          return;
        }
        createTogo();

      })



    })

    function createTogo() {
      // 從 localStorage 中獲取 memberId
      const memberId = localStorage.getItem('memberId');
      const togoMemo = document.getElementById("togoMemo").value;
      const restaurantId = document.getElementById("restaurantSelect").value;
      const togoPickupTime = document.getElementById("timeSelect").value;
      const tgName = document.getElementById("tgName").value;
      const tgPhone = document.getElementById("tgPhone").value;
      const couponDiscount = document.getElementById('couponDiscountTd').dataset.discount ? document.getElementById('couponDiscountTd').dataset.discount : 0//edit by hao
      const pointDiscount = document.getElementById('pointDiscountTd').dataset.discount ? document.getElementById('pointDiscountTd').dataset.discount : 0//edit by hao
      const discoutAmount = Number(couponDiscount) + Number(pointDiscount)//edit by hao
      const finalTotal = finalAmount - discoutAmount//edit by hao

      if (!restaurantId) {
        alert("請選擇餐廳");
        return;
      }

      if (!togoPickupTime) {
        alert("請選擇取餐時間");
        return;
      }

      // 建立訂單資料物件
      const togoData = {
        memberId,
        tgPhone,
        tgName,
        restaurantId,
        togoPickupTime,
        togoMemo,
        discoutAmount,
        finalTotal
      };
      // 發送 axios 請求來建立訂單
      axios.post('http://localhost:8080/SpanTasty/order/togo', togoData)
        .then(response => {
          if (response.data) {
            const togoId = response.data.togoId; // 獲取新建訂單的 ID
            console.log('togoId ' + togoId)
            // 接著建立訂單明細
            createOrderItems(togoId);
            // use(togoId);
          } else {
            console.log('無法建立訂單');
          }
        })
        .catch(error => {
          console.error('建立訂單過程中發生錯誤:', error);
        });
    }

    function createOrderItems(togoId) {
      // 取得購物車中的資料
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const newTogoItems = cart.map(item => {
        return {
          togoItemId: {
            togoId: togoId,
            foodId: item.foodId
          },
          amount: item.quantity,
          togoItemPrice: item.foodPrice * item.quantity // 計算價格
        };
      });
      console.log(newTogoItems)
      console.log('togoId ' + togoId)
      // 發送請求將訂單明細發送到後端
      axios.post(`http://localhost:8080/SpanTasty/order/togo/${togoId}/items`, newTogoItems)
        .then(response => {
          if (response.data) {
            console.log('訂單明細建立成功');
            alert('訂單已送出')
            // 清除 localStorage 中的購物車資料
            localStorage.removeItem('cart');

            /* 使用優惠券、累積點數 */
            const couponDiscount = document.getElementById('couponDiscountTd').dataset.discount
            const pointDiscount = document.getElementById('pointDiscountTd').dataset.discount
            console.log(finalAmount);

            axios.post('/SpanTasty/StarCups/coupon/allDiscount/togo', {
              couponDiscount: Number(couponDiscount),
              pointDiscount: Number(pointDiscount),
              shoppingId: togoId,
              couopnId: couponId,
              memberId: memberId,
              finalAmount: finalAmount
            })
              .then(res => {
                // 跳轉到成功頁面
                window.location.href = `/SpanTasty/StarCups/order/togo/information?id=${togoId}`;
              })
              .catch(err => {
                alert("請稍後再試")
              })

          } else {
            console.log('訂單明細建立失敗');
          }
        })
        .catch(error => {
          console.error('上傳訂單明細過程中發生錯誤:', error);
        });
    }

    // 載入縣市列表
    function loadCities() {
      axios.get('http://localhost:8080/SpanTasty/restaurant/city')
        .then(function (response) {
          var citySelect = document.getElementById("citySelect");
          citySelect.innerHTML = '<option value="">選擇縣市</option>';
          response.data.forEach(function (city) {
            var option = document.createElement("option");
            option.value = city;
            option.text = city;
            citySelect.appendChild(option);
          });
        })
        .catch(function (error) {
          console.error("無法載入縣市資料", error);
        });
    }

    // 當用戶選擇縣市時，載入對應鄉鎮
    function fetchTowns() {
      var city = document.getElementById("citySelect").value;
      if (city) {
        axios.get(`http://localhost:8080/SpanTasty/restaurant/${city}/towns`)
          .then(function (response) {
            var townSelect = document.getElementById("townSelect");
            townSelect.innerHTML = '<option value="">選擇鄉鎮</option>';
            response.data.forEach(function (town) {
              var option = document.createElement("option");
              option.value = town;
              option.text = town;
              townSelect.appendChild(option);
            });
            townSelect.disabled = false;  // 啟用鄉鎮選單
          })
          .catch(function (error) {
            console.error("無法載入鄉鎮資料", error);
          });
      }
    }

    // 當用戶選擇鄉鎮時，載入對應餐廳
    function fetchRestaurants() {
      var town = document.getElementById("townSelect").value;
      if (town) {
        axios.get(`http://localhost:8080/SpanTasty/restaurant/${town}/list`)
          .then(function (response) {
            var restaurantSelect = document.getElementById("restaurantSelect");
            restaurantSelect.innerHTML = '<option value="">選擇餐廳</option>';
            response.data.forEach(function (restaurant) {
              var option = document.createElement("option");
              option.value = restaurant.restaurantId; // 餐廳的唯一 ID
              option.text = restaurant.restaurantName; // 餐廳名稱
              // option.text = restaurant.restaurantAddress;
              restaurantSelect.appendChild(option);
            });
            restaurantSelect.disabled = false;  // 啟用餐廳選單
          })
          .catch(function (error) {
            console.error("無法載入餐廳資料", error);
          });
      } else {
        document.getElementById("restaurantSelect").disabled = true;
      }
    }



    function createPickupTime() {
      console.log("change")
      const restaurantId = document.getElementById("restaurantSelect").value;
      const timeSelect = document.getElementById("timeSelect");

      // 清空舊的選項
      timeSelect.innerHTML = '<option value="">選擇時間</option>'; // 在這裡清空選項

      axios.get(`http://localhost:8080/SpanTasty/order/togo/${restaurantId}/pickup`)
        .then(function (response) {
          const pickupTimes = response.data;
          console.log("時間選項" + pickupTimes)


          // 清空舊的選項


          // 將新選項添加到下拉選單
          pickupTimes.forEach(time => {
            const option = document.createElement("option");
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
          });
          timeSelect.disabled = false;
        })
        .catch(function (error) {
          console.error("獲取取餐時間失敗:", error);
        });
    }

    // 頁面載入時預先載入縣市選項
    window.onload = function () {
      loadCities();
    };

    function loadCartIntoTable() {
      // 從 localStorage 中獲取購物車數據
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      // 目標表格的 tbody 元素
      const tbody = document.querySelector(".table-custom.table-cart tbody");

      // 清空表格
      tbody.innerHTML = '';

      // 計算總金額
      let totalPrice = 0;

      // 如果購物車不為空，動態插入每個項目
      if (cart.length > 0) {
        cart.forEach(item => {
          const itemTotalPrice = item.foodPrice * item.quantity;
          totalPrice += itemTotalPrice;
          const rowHtml = `
          <tr>
            <td>
              <div class="table-cart-figure" style="margin-right: 30px;">
                <img src="${item.foodPicture}" alt="" width="146" height="132" />
              </div>
              <div class="table-cart-link">${item.foodName}</div>
            </td>
            <td>$${item.foodPrice}</td>
            <td>${item.quantity}</td>
            <td>$${itemTotalPrice}</td>
          </tr>`;

          // 插入新行到表格中
          tbody.insertAdjacentHTML('beforeend', rowHtml);
        });
      } else {
        // 如果購物車是空的，顯示一條提示信息
        tbody.innerHTML = `<tr><td colspan="4">購物車是空的。</td></tr>`;
      }

      // 更新總金額顯示
      document.querySelector(".cart-product-price").innerHTML = `<sup>$</sup>${totalPrice}`;

      // 將總金額放入表格中的 "Cart Subtotal" 和 "Total" 欄位
      document.getElementById("subtotal").innerText = `$${totalPrice}`;
      document.getElementById("total").innerText = `$${totalPrice}`;
    }

    // 取得會員資料
    function getProfile() {
      const token = localStorage.getItem('token');

      if (token) {
        axios.get('/SpanTasty/member/profile', {
          headers: {
            'Authorization': `${token}`
          }
        })
          .then(response => {
            if (response.data.success) {
              const member = response.data.data;
              // 取得 memberId
              var memberId = member.memberId;
              localStorage.setItem('memberId', memberId); // 儲存至 localStorage
              // 自動填入顧客資料
              // document.getElementById("tgName").value = member.memberName || ''; 
              // document.getElementById("tgPhone").value = member.phone || '';
              // 自動填入資料到輸入框中
              if (document.getElementById('tgName').value.trim() === '') {
                document.getElementById('tgName').value = member.memberName || '';
              }

              if (document.getElementById('tgPhone').value.trim() === '') {
                document.getElementById('tgPhone').value = member.phone || '';
              }
            } else {
              alert('無法獲取個人資訊');
            }
          })
          .catch(error => {
            console.error('獲取個人資訊過程中發生錯誤:', error);
          })
      } else {
        alert('請先登入')
      }
    }

  </script>
  <script>
    //折扣



    document.addEventListener('DOMContentLoaded', function () {


      const token = localStorage.getItem('token');
      if (!token) {
        console.error('Notoken found')
        alert('需要登入才能繼續')
        window.location.href = '/SpanTasty/StarCups/loginRegister'
        return;
      }

      axios.get('/SpanTasty/member/profile', {
        headers: {
          'Authorization': `${token}`
        }
      })
        .then(response => {
          if (response.data.success) {
            const memberData = response.data.data
            memberId = memberData.memberId
            console.log('會員資訊:', memberData);
            discountInfo(memberId)
          }
        })
        .catch(err => {
          throw new Error('無法獲取會員資訊')
        })


      let maxPointUse;
      function discountInfo(memberId) {
        axios.get('/SpanTasty/StarCups/togo/checkout', {
          headers: {
            'Content-Type': 'application/json'
          },
          params: {
            memberId: memberId
          }
        })
          .then(res => {
            console.log(res.data);
            maxPointUse = res.data.pointMemberTotalPoint
            pointHtmlMaker(res.data)

          })
          .catch(err => {
            console.error(err);
          })
      }




      function pointHtmlMaker(data) {
        document.getElementById('pointInfo').innerHTML = `
        <li class="active" style="font-size: 16px;" >可用點數 : ${data.pointMemberTotalPoint}點(1點折抵1元)</li>
        <li class="active" style="font-size: 16px;" >您有 ${data.pointMember.expiringPoints}點將於 ${data.pointMember.expiryDate}到期</li>`

      }
      let totalAmount;
      document.getElementById('selectCoupon').addEventListener('click', () => {
        var myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
        myModal.show();

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let totalPrice = count(cart);
        totalAmount = totalPrice
        function count(cart) {
          let totalPrice = 0;
          cart.forEach(item => {
            const itemTotalPrice = item.foodPrice * item.quantity;
            totalPrice += itemTotalPrice;
          })
          return totalPrice
        }
        console.log(cart);



        axios.post('http://localhost:8080/SpanTasty/StarCups/coupon/checkout/togo', {
          togoItems: cart,
          totalAmount: totalPrice,
          memberId: memberId
        })
          .then(res => {
            console.log('123');

            console.log(res.data);
            HtmlMaker(res.data)
            // let coupons = res.data
          })


      })

      function HtmlMaker(data) {
        const couponDiv = document.getElementById('couponDiv')
        couponDiv.innerHTML = ''
        data.forEach(coupon => {
          couponDiv.innerHTML += `
            <div class="row mt-1 ${coupon.canUse ? '' : 'cantUse'}">
              <div class="col d-flex mb-3">
                <div class="d-flex" style="background-color: rgb(232, 208, 192);"><img src="/SpanTasty/starcups/images/coupon/couponhead.png" width="87" height="87" alt=""></div>
                <div class="border w-100 d-flex justify-content-between">
                  <div class="ms-1 mt-1">                                                        
                    <ul class="">
                      <li class="text-start"><span>${coupon.coupon.rulesDescription}</span><span></span></li>
                      <li class="text-start"><span>低消: </span><span>$${coupon.coupon.minOrderDiscount ? coupon.coupon.minOrderDiscount : '-'}</span></li>
                      <li class="text-start"><span>最多折抵: </span><span>$${coupon.coupon.maxDiscount ? coupon.coupon.maxDiscount : '-'}</span></li>
                      <li class="text-start"><span>數量: </span><span>${coupon.usageAmount}</span></li>
                      <li class="text-start"><span>有效日期: </span><span>${coupon.coupon.couponEndDate}</span><a href="#" class="ms-2 rule" data-couponid=${coupon.coupon.couponId}>使用規則</a></li>
                    </ul>
                  </div>
                  <div class="d-flex align-items-center me-3">
                    <input type="radio"  name="radioCoupon" ${coupon.canUse ? '' : 'disabled'}  data-couponcode="${coupon.coupon.couponCode}" data-couponid="${coupon.coupon.couponId}">  
                  </div>                                                       
                </div>
              </div>
            </div>`
        });
      }

      //使用優惠券
      document.getElementById('useCoupon').addEventListener('click', () => {
        let couponCode = document.querySelector('input[name="radioCoupon"]:checked').dataset.couponcode
        couponId = document.querySelector('input[name="radioCoupon"]:checked').dataset.couponid
        document.getElementById('coupon-code').value = couponCode
        document.getElementById('coupon-code-label').textContent = ''

        axios.get("/SpanTasty/StarCups/coupon/discount", {
          params: {
            totalAmount: totalAmount,
            couponCode: couponCode
          }
        })
          .then(res => {
            console.log(res.data);
            couponDiscountHmtlMaker(res.data)
            changeTotal()
          }

          )
      })

      function couponDiscountHmtlMaker(data) {
        document.getElementById('couponDiscountTd').textContent = `-${data}`
        document.getElementById('couponDiscountTd').dataset.discount = data
      }


      //變更點數
      document.getElementById('pointInput').addEventListener('change', (e) => {
        console.log('touch');


        if (Number(e.target.value) > maxPointUse) {
          alert('超過點數上限')
          e.target.value = ''
          document.getElementById('pointDiscountTd').textContent = `-${e.target.value}`
          changeTotal()
          return
        }
        document.getElementById('pointDiscountTd').textContent = `-${e.target.value}`
        document.getElementById('pointDiscountTd').dataset.discount = e.target.value
        changeTotal()

      })

      //計算最終金額
      function changeTotal() {
        const couponDiscount = document.getElementById('couponDiscountTd').dataset.discount
        const pointDiscount = document.getElementById('pointDiscountTd').dataset.discount

        document.getElementById('total').textContent = `$${totalAmount - couponDiscount - pointDiscount}`
        document.getElementById('total').setAttribute('data-value', totalAmount - couponDiscount - pointDiscount)
        finalAmount = totalAmount - couponDiscount - pointDiscount
        return totalAmount - couponDiscount - pointDiscount
      }


      //使用規則
      document.addEventListener('click', function (event) {
        if (event.target.classList.contains('rule')) {
          event.preventDefault();
          const couponId = event.target.dataset.couponid
          window.open(`/SpanTasty/StarCups/coupon/${couponId}`)
        }
      })





    })

  </script>
  <!-- Javascript-->
  <script src="/SpanTasty/starcups/js/core.min.js"></script>
  <script src="/SpanTasty/starcups/js/script.js"></script>
</body>

</html>